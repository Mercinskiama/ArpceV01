
{% extends "ErpProject/ModuleStock/shared/layout.html" %}
{% block page %} {% load humanize %} {% load static %} {% load account_filters %} {% load calculs %}
<style type="text/css">
    .kanban_image {
        width: 70px;
        height: 70px;
        display: inline-block;
        position: relative;
        text-align: center;
        background-size: contain;
    }
    .kanban_image[data-mimetype='application/pdf'] {
        background-image: url({% static 'ErpProject/image/mimetypes/pdf.svg' %});
    }
    .badge_red{
        align-items: center;
        background-color: #FFBB00;
        border-radius: 10%;
        color: rgba(255, 255, 255, 0.87);
        display: flex;
        font-size: 0.8em;
        height: 20px;
        justify-content: center;
        left: 7%;
        pointer-events: none;
        position: absolute;
        top: 52px;
        transform: translate(-50%, -50%);
        width: 80px;
    }
    .badge_green {  
        align-items: center;
        background-color: #0ac213;
        border-radius: 10%;
        color: rgba(255, 255, 255, 0.87);
        display: flex;
        font-size: 0.8em;
        height: 20px;
        justify-content: center;
        left: 7%;
        pointer-events: none;
        position: absolute;
        top: 52px;
        transform: translate(-50%, -50%);
        width: 80px;
    }
</style>
<div class="row">
    <ul class="breadcrumb">
        <li><a href="{% url 'backoffice_index' %}"><span class="mif-home"></span></a></li>
        <li><a class="chargement-au-click" href="{% url 'module_stock_index' %}">Module Stock</a></li>
        <li><a class="chargement-au-click" href="{% url 'module_stock_list_ajustement' %}">Liste des Inventaires</a></li>
        <li>{{ title }}</li>
    </ul>
</div>

<div class="row">
    <div class="col-lg-12">
        <h2>{{ title }}</h2>
        
        <strong style="float: right;color: grey;opacity: 0.4;margin-top: -30px;">{% now "jS F Y H:i" %}</strong>
        <div class="separ" style="background-color: grey;opacity: 0.2"></div>
        
        <!-- GESTION DU WORKFLOW -->
        {% include 'ErpProject/ErpBackOffice/widget/workflow.html' with utilisateur=utilisateur model=model content_type_id=content_type_id historique=historique roles=roles etapes_suivantes=etapes_suivantes url_add="module_stock_add_ajustement" url_detail="module_stock_detail_ajustement" csrf_token=csrf_token module=module type_doc="Inventaire" only %}
        <!--FIN GESTION DU WORKFLOW--> 

        <div class="panel panel-default" style="border: none; margin-top: 1rem;">
            <div class="panel panel-body" style="background-color:#f5f5f5;border: none;border-radius: none;">
                <div class="row">
                    {% if lignes|length > 0 %}
                        {% if model.status.id != 2 %}
                            <button onclick="javascript:document.getElementById('submit').click()" class="validate-btn theme-btn theme-btn-sm rounded primary_color_{{module.name|lower}}">valider</button>
                        {% endif %}
                    {% endif %}
                    {% comment %} {% if user_actions.can_update is True %}<button onclick="javascript:window.location.assign('{% url 'module_stock_update_ajustement' model.id %}')" class="validate-btn theme-btn theme-btn-sm rounded primary_color_{{module.name|lower}}">Modifier</button>{% endif %} {% endcomment %}
                    {% comment %} {% if user_actions.can_create is True %}<button onclick="javascript:window.location.assign('{% url 'module_stock_duplicate_ajustement' model.id %}')" class="validate-btn theme-btn theme-btn-sm rounded chargement-au-click">Dupliquer</button>{% endif %} {% endcomment %}
                    <button onclick="javascript:window.location.assign('{% url 'module_stock_print_ajustement' model.id %}')" class="validate-btn theme-btn theme-btn-sm rounded ">Imprimer</button>
                    {% if user_actions.can_delete is True %}<button id="supprimer" class="validate-btn theme-btn theme-btn-sm rounded danger chargement-au-click">Supprimer</button>{% endif %}
                    <button onclick="javascript:window.location.assign('{% url 'module_stock_list_ajustement' %}')" class="theme-btn theme-btn-sm rounded" style="width: 20%;margin-left: 5px">Annuler</button>
                </div>

                <hr class="hr-ligne">
                <!-- Appel de la fonction message -->
                {% include 'ErpProject/ErpBackOffice/widget/message.html' with messages=messages only %}<br>
                
                <div class="row">
                    <div class="col-md-6">
                        <p>Référence :<br>
                            <span class="sub-alt-header">{{ model.reference }}</span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p>Date :<br>
                            <span class="sub-alt-header">{{model.date|date:"d/m/Y H:i"}}</span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p>Emplacement :<br>
                            {% if model.emplacement is None %}
                            <span class="sub-alt-header"> - </span>
                            {% else %}
                            <span class="sub-alt-header"><a class="link chargement-au-click" href="">{{ model.emplacement }}</a></span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p>Statut Inventaire :<br>
                            {% if model.status is None %}
                                 <span class="sub-alt-header"> - </span>
                            {% elif model.status.id == 2 %}
                                    <span style="font-weight:700;">{{model.status}}</span> <br> <span class="badge_green rounded-pill text-bg-primary">Fini</span> 
                            {% else %}
                                    <span style="font-weight:700;">{{model.status}}</span> <br> <span class="badge_red rounded-pill text-bg-primary">En cours</span>
                            {% endif %}
                            
                        </p>
                    </div>
                    <div class="col-md-12" style="margin-bottom:2%;">

                    </div>
                    <div class="col-md-6">
                        <p>Inventaire de :<br>
                            <span class="sub-alt-header">
                                {% if model.inventaire_de == 0 %}
                                    Tous les Articles au stock
                                {% elif model.inventaire_de == 1 %}
                                    Categorie D'article
                                {% else %}
                                    un Article
                                {% endif %}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p>Document :<br>
                            <span class="sub-alt-header">{{ model.document }}</span>
                        </p>
                    </div>
                </div>     
                <br><br>
                <div class="row">
                    <ul class="nav nav-tabs navtab-bg"> 
                        <li class="active"><a href="#ajustement" data-toggle="tab" aria-expanded="false"><span>Inventaire</span></a></li>
                        <li class=""><a href="#frame_documents" data-toggle="tab" aria-expanded="false"><span>Documents associés</span></a></li>
                    </ul>
                    <div class="tab-content"> 
                        <div class="tab-pane active" id="ajustement">
                            <div class="row margin20 no-margin-left no-margin-right">
                                {% if model.status.id != 2 %}
                                    <form class="needs-validation" novalidate  method="POST" action="{% url 'module_stock_post_cloturer_ajustement' %}">
                                        {% csrf_token %}
                                        <input id="submit" type="submit" style="display: none">
                                        <input type="hidden" name="inventaire_id" value="{{model.id}}">
                                        <table id="tbl_posts" class="table table-bordered">
                                            <thead style="background-color: grey; color: white;" >
                                                <th style="color: white;">Article</th>
                                                <th style="color: white;">Unité</th>
                                                <th style="color: white;">Lieu</th>
                                                <th style="color: white;">Quantité théoriques</th>
                                                <th style="color: white;">Quantité physique</th>
                                            </thead>
                                            <tbody id="tbl_posts_body">
                                                {% if lignes|length > 0 %}
                                                    {% for item in lignes %}
                                                        <tr id="rec-1">
                                                            <input type="hidden" name="ligne_id" value="{{item.id}}">
                                                            <input id="qt_bcp_{{item.id}}" class="form-control" type="hidden" value="{{item.quantite_theorique}}" disabled>
                                                            <input id="article_{{item.id}}" class="form-control" type="hidden" value="{{item.article_id}}" disabled>
                                                            <td>
                                                                {{item.designation}}
                                                            </td>
                                                            <td>
                                                                <select id="{{item.id}}" class="form-control unite" name="unite_id">
                                                                    {% for itm in item.unites %}
                                                                        <option value="{{itm.id}}">{{itm.short_name}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </td>
                                                            <td>
                                                                {{model.emplacement.designation}}
                                                            </td>
                                                            <td>
                                                                <input id="qt{{item.id}}" name="qte_theorique" class="form-control" type="hidden" value="{{item.quantite_theorique}}">
                                                                <input id="qt2{{item.id}}" class="form-control" type="text" value="{{item.quantite_theorique}}" disabled>
                                                            </td>
                                                            <td>
                                                                <input id="qr{{item.id}}" name="qte_reele" step="0.0001" type="number" class="form-control" style="" value="{{item.quantite_theorique}}" placeholder="saisiez la quantité que vous avez trouvé dans le stock physique Ex: 2" required>
                                                            </td>
                                                            <!--td><a class="btn btn-xs delete-record" data-id="1"><i class="glyphicon glyphicon-trash"></i></a></td-->
                                                        </tr>
                                                    {% endfor %}7
                                                {% else %}
                                                    <tr id="rec-1">
                                                        <td colspan="6" style="text-align: center;">No ligne</td>
                                                    </tr>
                                                {% endif%}
                                            </tbody>
                                        </table>
                                    </form>
                                {% else %}
                                    <table id="tbl_posts" class="table table-bordered">
                                        <thead style="background-color: grey; color: white;" >
                                            <th style="color: white;">Article</th>
                                            <th style="color: white;">Lieu</th>
                                            <th style="color: white;">Quantité théoriques</th>
                                            <th style="color: white;">Quantité physique</th>
                                            <th style="color: white;">Ecart</th>
                                        </thead>
                                        <tbody id="tbl_posts_body">
                                            {% if lignes|length > 0 %}
                                                {% for item in lignes %}
                                                    <tr id="rec-1">
                                                        <input type="hidden" name="ligne_id" value="{{item.id}}">
                                                        <td>
                                                            {{item.designation}}
                                                        </td>
                                                        <td>
                                                            {{model.emplacement.reference}}
                                                        </td>
                                                        <td>
                                                            {{item.quantite_theorique}} {{item.ligne.unite.short_name}}
                                                        </td>
                                                        <td>
                                                            {{item.quantite_reelle}} {{item.ligne.unite.short_name}}
                                                        </td>
                                                        <td>
                                                            {% sous item.quantite_reelle item.quantite_theorique %}
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            {% else %}
                                                    <tr id="rec-1">
                                                        <td colspan="6" style="text-align: center;">No ligne</td>
                                                    </tr>
                                            {% endif%}
                                        </tbody>
                                    </table>
                                {% endif %}
                            </div>
                        </div>
                        <div class="tab-pane" id="frame_documents">
                            <div class="row margin20 no-margin-left no-margin-right">
                                {% for item in documents %}
                                <div class="col-md-4">
                                    <div class="card-item" style="margin-top: 10px; margin-bottom: 15px">
                                        <div class="card-item-content" style="margin: 10px">
                                            <div class="thumb kanban_image" data-mimetype="application/pdf">
                                            </div>
                                            <div class="texts">
                                                <div class="texts-record_selector">
                                                    <a class="link chargement-au-click" href="{% if item.fichier %}{% static item.fichier.url %}{% else %}{% url 'module_archivage_detail_document' item.id %}{% endif %}" style="float: left;">{{ item.designation }}</a>
                                                </div>
                                                <br>
                                                <div class="mt-2"></div>
                                                <span class="inner-text">{{ item.dossier.designation }}</span><br>
                                                <div class="texts-favorite">
                                                    <span class="inner-text" style="float: left;">{{ item.creation_date|date:'d/m/Y' }}</span>
                                                </div>
                                                <br>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}                    
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    //-------  Deux variables pour la suppression  ---------------
    var modele = "Model_Ajustement"
    var the_url = "module_stock_list_ajustement"
</script>
{% include 'ErpProject/ErpBackOffice/widget/item_view.html' %}
{% endblock %}